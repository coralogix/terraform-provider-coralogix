## Guide to Using the Migration Script

This guide explains how to use the provided script for automating Terraform resource migrations. The script dynamically generates necessary Terraform configuration files, runs Terraform commands, and cleans up intermediate files. It uses color-coded logging for better visibility.

---

### Prerequisites

Before using the script, ensure the following tools are installed and accessible in your environment:

1. **Go**:
    - For running the Go scripts (`generate_imports.go` and `json_to_hcl.go`).

2. **Terraform**:
    - To manage infrastructure resources.

3. **Python 3**:
    - To execute the embedded script for cleaning JSON files.

4. **hcl2json**:
    - A tool for converting HCL to JSON.

5. **tput**:
    - For colorized terminal output.

---

### Script Functionality

1. **Input Handling**:
    - Accepts either a Terraform directory or a resource type as input.
    - Automatically detects whether the input is a directory or resource type.

2. **Generates Necessary Files**:
    - Creates a migration folder (`<input>_migration`) to store all generated files.
    - Runs `generate_imports.go` to create `imports.tf`.
    - Creates a `provider.tf` with necessary provider configuration.

3. **Terraform Operations**:
    - Runs `terraform plan` and outputs a configuration file (`generated.tf`).
    - Converts `generated.tf` to JSON format using `hcl2json`.

4. **JSON Cleaning**:
    - Removes null values from the JSON configuration.

5. **Converts JSON Back to HCL**:
    - Uses `json_to_hcl.go` to generate a cleaned Terraform file (`cleaned_config.tf`).

6. **Applies Terraform Configuration**:
    - Runs `terraform apply` to apply the migration.

7. **Cleanup**:
    - Removes temporary files (`imports.tf`, `config.json`, etc.) after completion.

---

### How to Use the Script

#### Step 1: Save the Script
Save the script as `migration_script.sh` and make it executable:

```bash
chmod +x migration_script.sh
```

#### Step 2: Run the Script
Provide either a directory path or a resource type as an argument:

```bash
# For a Terraform directory
./migration_script.sh /path/to/terraform_directory

# For a resource type
./migration_script.sh resource-type
```

#### Step 3: Inspect Logs
The script uses color-coded logs for better readability:
- **Blue [INFO]**: General progress messages.
- **Green [DEBUG]**: Debug information.
- **Yellow [WARNING]**: Non-critical warnings.
- **Red [ERROR]**: Errors that cause the script to exit.

Example log snippet:
```plaintext
2024-12-01 14:23:22 [INFO] Running terraform plan with configuration output...
2024-12-01 14:23:23 [INFO] Successfully generated imports.tf at /path/to/terraform_directory_migration.
2024-12-01 14:23:24 [WARNING] Terraform plan might fail; continuing.
2024-12-01 14:23:25 [ERROR] Failed to convert Terraform file to JSON.
```

#### Step 4: Review Outputs
The following files will be generated in the `<input>_migration` folder:
- `imports.tf`: Generated by `generate_imports.go`.
- `provider.tf`: Provider configuration.
- `generated.tf`: Output of `terraform plan`.
- `cleaned_config.tf`: Cleaned and finalized Terraform configuration.

#### Step 5: Cleanup
The script automatically cleans up intermediate files after successful execution:
- `imports.tf`
- `config.json`
- `cleaned_config.json`

---

### Example Usage

#### Input: Terraform Directory
```bash
./migration_script.sh /path/to/my_terraform_directory
```

**Output**:
- A new folder `/path/to/my_terraform_directory_migration` containing the migration files.

---

### Troubleshooting

1. **Error: Command Not Found**
    - Ensure the required tools (`terraform`, `go`, `python3`, `hcl2json`) are installed and accessible in your `PATH`.

2. **Colorless Logs**:
    - Verify your terminal supports ANSI colors and `tput`.

3. **Go Script Errors**:
    - Ensure `generate_imports.go` and `json_to_hcl.go` are present and compilable.

4. **Terraform Apply Errors**:
    - Check your Terraform configuration for syntax or validation issues.

---

### Additional Notes

- The script is designed to fail fast (`set -e`), exiting on the first critical error.
- Logs are enriched with timestamps for better traceability.
- You can customize the color codes in the `log` function to suit your preferences.